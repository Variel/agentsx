# AgentsX 요구사항 명세

## 1. 목적
서로 다른 컴퓨터에서 코딩 에이전트 설정을 동기화하기 위한 로컬 CLI 도구를 제공한다.

- 실행 방식: `npx agentsx ...`
- 로컬 상태 저장소: `~/.agentsx`
- 원격 상태 저장소: 사용자가 `init`으로 지정한 Git 리포지토리

## 2. 핵심 사용자 시나리오
1. 사용자는 `npx agentsx init <repo-url>`로 원격 저장소를 등록한다.
2. 사용자는 `npx agentsx push <agent>`로 로컬 설정을 원격 저장소(`agents/<agent>/...`)로 업로드한다.
3. 사용자는 `npx agentsx pull <agent>`로 원격 설정을 로컬로 내려받는다.
4. 사용자는 `npx agentsx sync <agent>`로 양방향 동기화를 수행한다.

## 3. 지원 범위

### 3.1 지원 에이전트 (v1)
- codex
- claude code
- cursor
- open code
- copilot

### 3.2 동기화 대상 설정 카테고리
- skills
- plugins / extensions
- mcp
- 지시사항 문서 (`AGENTS.md`, `CLAUDE.md` 등)
- 기타 에이전트 전용 설정 파일

v1에서는 사용자 전역 설정(`home` 범위)만 동기화 대상으로 취급한다.  
프로젝트 로컬 경로(`./...`) 설정은 동기화 대상에서 제외한다.

구조화 설정 파일(`json`, `yaml`, `toml`)은 파일 전체 동기화 외에 하위 경로 단위 선택 동기화를 지원해야 한다.

카테고리는 에이전트별 어댑터 정의를 통해 확장 가능해야 하며, 하드코딩 분기(`if agent===...`) 대신 레지스트리 기반으로 처리한다.

## 4. CLI 명령 요구사항

### 4.1 `init`
- 형식: `npx agentsx init <repo-url>`
- 동작:
1. `~/.agentsx` 생성
2. 상태 파일 생성/갱신
3. 원격 리포지토리를 로컬 미러 경로(예: `~/.agentsx/repos/<slug>`)에 clone 또는 연결
4. 이후 `push/pull/sync`가 즉시 가능해야 함

### 4.2 `push`
- 형식: `npx agentsx push <agent> [targets...]`
- 동작:
1. 에이전트별 로컬 설정 경로에서 대상 파일 탐색
2. 원격 저장소의 `agents/<agent>/`로 복사
3. Git add/commit/push 수행

- 대상 선택 방식:
1. `[targets...]`가 있으면 CLI 비대화형 모드
2. `[targets...]`가 없으면 TUI로 선택
   - 화살표 이동
   - 스페이스 토글
   - 엔터 확정
3. 구조화 설정 파일은 `--jsonpath targetId=$.path` 형식으로 하위 경로 동기화를 지정 가능
4. TUI 모드에서는 구조화 설정 파일에 대해 트리 탐색 기반 하위 경로 선택을 지원

### 4.3 `pull`
- 형식: `npx agentsx pull <agent> [targets...]`
- 동작:
1. 원격 저장소의 `agents/<agent>/` 읽기
2. 에이전트별 로컬 설정 경로로 복원

- 대상 선택 방식 및 충돌 처리 UX는 `push`와 동일한 원칙 사용

### 4.4 `sync`
- 형식: `npx agentsx sync <agent> [targets...]`
- 동작:
1. 로컬/원격 양쪽 상태 비교
2. 단방향 신규 파일은 반대편으로 전파
3. 동일 경로 변경 충돌은 충돌 정책에 따라 처리
4. 원격 변경이 있으면 Git commit/push
5. 구조화 설정 파일에 대한 하위 경로 선택(`jsonpath`)이 지정되면 해당 경로만 반대편 파일에 병합 적용

## 5. 충돌 처리 요구사항

### 5.1 공통 충돌 정책
충돌 시 사용자가 아래 정책 중 선택 가능해야 한다.
- `fail-all` (전체실패): 충돌 발생 시 명령 전체 실패
- `overwrite` (덮어쓰기): 현재 연산 기준 우선 소스를 반대편에 적용
  - push: 로컬이 원격 덮어씀
  - pull: 원격이 로컬 덮어씀
  - sync: 수정 시간이 더 최신인 쪽을 승자로 적용
- `partial` (부분실패): 충돌 항목은 건너뛰고 나머지만 처리

구조화 설정(`json/yaml/toml`)에 대해 JSONPath 선택이 지정된 경우, 충돌 판정은 파일 단위가 아닌 JSONPath 선택 단위로 수행한다.

### 5.2 모드별 UX
- CLI 모드(`[targets...]` 지정): 정책을 옵션으로 선택 가능
- TUI 모드(`[targets...]` 미지정): 충돌 항목별 선택 UI 제공 (JSONPath 선택이 있을 경우 `파일#jsonpath` 형태로 표시)

구조화 설정 탐색 TUI는 아래 키 동작을 지원해야 한다.\n- `←/→`: 트리 접기/펼치기\n- `↑/↓`: 포커스 이동\n- `Space`: 현재 노드와 하위 노드 일괄 선택/해제\n- `Enter`: 파일+JSON 트리 선택 확정\n- 열린 하위 노드의 상/하단에서 `↑/↓`를 누르면 상위/다음 항목으로 자연스럽게 이어서 이동

### 5.3 충돌 선택값 저장
- 사용자의 충돌 선택은 `~/.agentsx` 상태 파일에 저장한다.
- 동일한 조건(명령/에이전트/대상)에 대해 다음 실행 시 기본적으로 재질문하지 않는다.
- 사용자가 명시 옵션을 주면 저장된 기본값보다 우선한다.

## 6. 로컬 상태 저장소 (`~/.agentsx`)

### 6.1 필수 저장 정보
- 스키마 버전
- 원격 리포지토리 URL
- 로컬 미러 경로
- 기본 브랜치
- 마지막 동기화 시각
- 충돌 정책 기본값 및 항목별 선택 캐시

### 6.2 데이터 무결성
- 상태 파일이 없거나 손상되면 복구 가능한 에러 메시지 제공
- 쓰기 시 원자적 저장(임시 파일 후 rename)

## 7. Git 동작 요구사항
- 원격 저장소 반영 전 최신 상태 fetch/pull
- 원격 저장소에 기본 브랜치가 아직 없으면(`origin/<default-branch>` 미존재) 첫 `push/pull/sync` 시 자동으로 브랜치를 초기화한다.
- 변경 없으면 commit/push 생략
- commit 메시지에 명령/에이전트/타임스탬프 포함
- 인증 실패/권한 실패 시 원인 중심 에러 안내

## 8. 확장성/아키텍처 요구사항
- 에이전트별 경로/규칙은 어댑터 플러그인으로 분리
- 명령 로직은 공통 동기화 엔진을 재사용
- 파일 충돌 판별, 정책 적용, 복사 계획 생성은 순수 함수 중심으로 구현
- 향후 새 에이전트 추가 시 기존 명령 코드 변경을 최소화(등록만으로 동작)

## 9. 품질 요구사항
- TypeScript strict 모드
- 타입 체크, 린트, 테스트 스크립트 제공
- 핵심 로직(충돌 판별/정책 적용/계획 수립) 단위 테스트 포함

## 10. 비기능 요구사항
- 기본 OS: macOS/Linux (Windows 경로 확장은 차후)
- 대량 파일에서도 진행률/요약 출력
- 실패 시 원인과 복구 방법을 한국어로 안내

## 11. 제외 범위 (v1)
- 암호화/비밀정보 마스킹 자동화
- 실시간 파일 감시 기반 자동 동기화 데몬
- GUI 앱
